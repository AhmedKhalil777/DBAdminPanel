<div class="sql-execution-container">
  <mat-card class="sql-card">
    <mat-card-header>
      <div mat-card-avatar class="sql-avatar">
        <mat-icon>code</mat-icon>
      </div>
      <mat-card-title>SQL Execution</mat-card-title>
      <mat-card-subtitle>Execute native SQL queries</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="sql-input-container">
        <div class="sql-editor-wrapper">
          <div class="line-numbers" #lineNumbers></div>
          <div class="sql-editor">
            <div class="highlighted-code" #highlightedCode></div>
            <textarea
              #sqlInput
              class="sql-input"
              [value]="sqlQuery()"
              (input)="onSqlInput($event)"
              (keydown)="onSqlKeyDown($event)"
              (blur)="onSqlBlur()"
              placeholder="Enter your SQL query here..."
              spellcheck="false">
            </textarea>
            @if (autocompleteVisible() && autocompleteItems().length > 0) {
              <div 
                class="autocomplete-dropdown" 
                #autocompleteDropdown
                [style.top.px]="autocompletePosition().top"
                [style.left.px]="autocompletePosition().left">
                @for (item of autocompleteItems(); track item.value; let i = $index) {
                  <div 
                    class="autocomplete-item"
                    [class.selected]="i === autocompleteSelectedIndex()"
                    [class.function]="item.type === 'function'"
                    [class.table]="item.type === 'table'"
                    [class.column]="item.type === 'column'"
                    [class.keyword]="item.type === 'keyword'"
                    (click)="selectAutocompleteItem(i)"
                    (mouseenter)="autocompleteSelectedIndex.set(i)">
                    <mat-icon class="autocomplete-icon">
                      @switch (item.type) {
                        @case ('function') { functions }
                        @case ('table') { table_chart }
                        @case ('column') { view_column }
                        @case ('keyword') { code }
                      }
                    </mat-icon>
                    <div class="autocomplete-content">
                      <div class="autocomplete-label">{{ item.label }}</div>
                      @if (item.description) {
                        <div class="autocomplete-description">{{ item.description }}</div>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>

      <div class="sql-actions">
        <button 
          mat-raised-button 
          color="primary" 
          (click)="executeSql()"
          [disabled]="isExecuting() || !sqlQuery().trim()">
          <mat-icon>play_arrow</mat-icon>
          Execute
        </button>
        <button 
          mat-button 
          (click)="clearQuery()"
          [disabled]="isExecuting()">
          <mat-icon>clear</mat-icon>
          Clear
        </button>
        <button 
          mat-button 
          [matMenuTriggerFor]="themeMenu"
          [disabled]="isExecuting()"
          matTooltip="Change SQL syntax highlighting theme">
          <mat-icon>palette</mat-icon>
          Theme: {{ currentTheme().displayName }}
          <mat-icon>arrow_drop_down</mat-icon>
        </button>
        <mat-menu #themeMenu="matMenu">
          @for (theme of themes; track theme.name) {
            <button 
              mat-menu-item 
              (click)="changeTheme(theme.name)"
              [class.active-theme]="currentTheme().name === theme.name">
              <mat-icon>{{ currentTheme().name === theme.name ? 'check' : '' }}</mat-icon>
              <span>{{ theme.displayName }}</span>
            </button>
          }
        </mat-menu>
        @if (sqlSamples().length > 0) {
          <button 
            mat-button 
            [matMenuTriggerFor]="samplesMenu"
            [disabled]="isExecuting()">
            <mat-icon>code</mat-icon>
            SQL Samples
            <mat-icon>arrow_drop_down</mat-icon>
          </button>
          <mat-menu #samplesMenu="matMenu">
            @for (sample of sqlSamples(); track sample.name) {
              <button mat-menu-item (click)="loadSample(sample)">
                <mat-icon>description</mat-icon>
                <span>
                  <div>{{ sample.name }}</div>
                  @if (sample.description) {
                    <div class="sample-description">{{ sample.description }}</div>
                  }
                </span>
              </button>
            }
          </mat-menu>
        }
        @if (databaseType() !== 'Unknown') {
          <mat-chip>
            <mat-icon>storage</mat-icon>
            {{ databaseType() }}
          </mat-chip>
        }
        @if (executionTime() !== null) {
          <mat-chip class="execution-time">
            <mat-icon>schedule</mat-icon>
            {{ executionTime() }}ms
          </mat-chip>
        }
      </div>

      @if (isExecuting()) {
        <div class="executing-indicator">
          <mat-spinner diameter="24"></mat-spinner>
          <span>Executing query...</span>
        </div>
      }

      @if (sqlResult()) {
        <mat-divider class="result-divider"></mat-divider>
        <div class="result-section">
          <div class="result-header">
            <h3>Query Results</h3>
            <mat-chip class="row-count">
              <mat-icon>table_chart</mat-icon>
              {{ sqlResult()!.rowCount }} row(s)
            </mat-chip>
          </div>
          <div class="table-container">
            <table mat-table [dataSource]="dataSource()" class="result-table">
              @for (column of displayedColumns(); track column) {
                <ng-container [matColumnDef]="column">
                  <th mat-header-cell *matHeaderCellDef>{{ column }}</th>
                  <td mat-cell *matCellDef="let row">
                    <span [innerHTML]="formatValue(row[column])"></span>
                  </td>
                </ng-container>
              }
              <tr mat-header-row *matHeaderRowDef="displayedColumns()"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns()"></tr>
            </table>
          </div>
        </div>
      }

      @if (rowsAffected() !== null && !sqlResult()) {
        <mat-divider class="result-divider"></mat-divider>
        <div class="result-section">
          <div class="result-header">
            <h3>Execution Result</h3>
            <mat-chip class="rows-affected" color="primary">
              <mat-icon>check_circle</mat-icon>
              {{ rowsAffected() }} row(s) affected
            </mat-chip>
          </div>
        </div>
      }

      @if (executionLogs().length > 0) {
        <mat-divider class="log-divider"></mat-divider>
        <div class="logs-section">
          <div class="logs-header">
            <h3>Execution Logs</h3>
            <button mat-icon-button (click)="executionLogs.set([])" matTooltip="Clear logs">
              <mat-icon>clear</mat-icon>
            </button>
          </div>
          <div class="logs-container">
            @for (log of executionLogs(); track log.timestamp.getTime()) {
              <div class="log-entry" [class]="'log-' + log.level">
                <span class="log-timestamp">{{ log.timestamp | date:'HH:mm:ss.SSS' }}</span>
                <span class="log-level">{{ log.level.toUpperCase() }}</span>
                <span class="log-message">{{ log.message }}</span>
              </div>
            }
          </div>
        </div>
      }
    </mat-card-content>
  </mat-card>
</div>

