@{
    ViewData["Title"] = "Entity Management";
    var entityName = ViewData["EntityName"]?.ToString() ?? "";
}

<h1 id="entityTitle" data-entity-name="@entityName">Loading...</h1>

<div id="loadingMessage" class="alert alert-info">Loading entity data...</div>
<div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

<div id="contentArea" style="display: none;">
    <p>
        <button class="btn btn-primary" onclick="showCreateForm()">Create New</button>
    </p>
    
    <table class="table" id="entitiesTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
    </table>
    
    <!-- Create/Edit Modal -->
    <div class="modal fade" id="entityModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Create Entity</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEntity()">Save</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let entityName = document.getElementById('entityTitle').getAttribute('data-entity-name') || '';
let entityMetadata = null;
let currentEntity = null;
let isEditMode = false;

async function loadMetadata() {
    try {
        const response = await fetch(`/DBAdminPanel/api/entities/${entityName}/metadata`);
        if (!response.ok) throw new Error('Failed to load metadata');
        entityMetadata = await response.json();
        document.getElementById('entityTitle').textContent = entityMetadata.name + ' Management';
        loadEntities();
    } catch (error) {
        showError('Failed to load entity metadata: ' + error.message);
    }
}

async function loadEntities() {
    try {
        const response = await fetch(`/DBAdminPanel/Entity/api/${entityName}`);
        if (!response.ok) throw new Error('Failed to load entities');
        const entities = await response.json();
        renderTable(entities);
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('contentArea').style.display = 'block';
    } catch (error) {
        showError('Failed to load entities: ' + error.message);
    }
}

function renderTable(entities) {
    const thead = document.getElementById('tableHead');
    const tbody = document.getElementById('tableBody');
    
    // Build header
    let headerRow = '<tr>';
    entityMetadata.properties.forEach(prop => {
        headerRow += `<th>${prop.name}</th>`;
    });
    headerRow += '<th>Actions</th></tr>';
    thead.innerHTML = headerRow;
    
    // Build rows
    tbody.innerHTML = '';
    entities.forEach(entity => {
        let row = '<tr>';
        entityMetadata.properties.forEach(prop => {
            const value = entity[prop.name] ?? '';
            row += `<td>${value}</td>`;
        });
        row += '<td>';
        row += `<button class="btn btn-sm btn-primary" onclick="editEntity('${entity[entityMetadata.keyProperty]}')">Edit</button> `;
        row += `<button class="btn btn-sm btn-info" onclick="viewDetails('${entity[entityMetadata.keyProperty]}')">Details</button> `;
        row += `<button class="btn btn-sm btn-danger" onclick="deleteEntity('${entity[entityMetadata.keyProperty]}')">Delete</button>`;
        row += '</td></tr>';
        tbody.innerHTML += row;
    });
}

function showCreateForm() {
    isEditMode = false;
    currentEntity = null;
    document.getElementById('modalTitle').textContent = 'Create ' + entityMetadata.name;
    renderForm();
    new bootstrap.Modal(document.getElementById('entityModal')).show();
}

function editEntity(id) {
    isEditMode = true;
    loadEntity(id);
}

async function loadEntity(id) {
    try {
        const response = await fetch(`/DBAdminPanel/Entity/api/${entityName}/${id}`);
        if (!response.ok) throw new Error('Failed to load entity');
        currentEntity = await response.json();
        document.getElementById('modalTitle').textContent = 'Edit ' + entityMetadata.name;
        renderForm();
        new bootstrap.Modal(document.getElementById('entityModal')).show();
    } catch (error) {
        showError('Failed to load entity: ' + error.message);
    }
}

function renderForm() {
    const modalBody = document.getElementById('modalBody');
    let form = '<form id="entityForm">';
    
    entityMetadata.properties.forEach(prop => {
        if (prop.isKey && isEditMode) {
            form += `<input type="hidden" name="${prop.name}" value="${currentEntity?.[prop.name] ?? ''}" />`;
        } else if (!prop.isKey) {
            const value = currentEntity?.[prop.name] ?? '';
            const inputType = prop.inputType || 'text';
            form += `<div class="mb-3">`;
            form += `<label class="form-label">${prop.name}</label>`;
            
            if (inputType === 'checkbox') {
                const checked = value === true || value === 'true' || value === 'True' ? 'checked' : '';
                form += `<div class="form-check">`;
                form += `<input type="checkbox" class="form-check-input" name="${prop.name}" ${checked} />`;
                form += `<label class="form-check-label">${prop.name}</label>`;
                form += `</div>`;
            } else if (inputType === 'datetime-local') {
                // Convert DateTime to datetime-local format (YYYY-MM-DDTHH:mm)
                let dateValue = '';
                if (value) {
                    const date = new Date(value);
                    if (!isNaN(date.getTime())) {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        dateValue = `${year}-${month}-${day}T${hours}:${minutes}`;
                    }
                }
                form += `<input type="datetime-local" class="form-control" name="${prop.name}" value="${dateValue}" />`;
            } else if (inputType === 'date') {
                // Convert DateOnly to date format (YYYY-MM-DD)
                let dateValue = '';
                if (value) {
                    const date = new Date(value);
                    if (!isNaN(date.getTime())) {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        dateValue = `${year}-${month}-${day}`;
                    }
                }
                form += `<input type="date" class="form-control" name="${prop.name}" value="${dateValue}" />`;
            } else if (inputType === 'time') {
                // Convert TimeOnly to time format (HH:mm)
                let timeValue = '';
                if (value) {
                    const date = new Date(value);
                    if (!isNaN(date.getTime())) {
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        timeValue = `${hours}:${minutes}`;
                    }
                }
                form += `<input type="time" class="form-control" name="${prop.name}" value="${timeValue}" />`;
            } else if (inputType === 'number') {
                form += `<input type="number" class="form-control" name="${prop.name}" value="${value}" step="${prop.type.includes('decimal') || prop.type.includes('float') || prop.type.includes('double') ? 'any' : '1'}" />`;
            } else {
                // Default to text
                form += `<input type="text" class="form-control" name="${prop.name}" value="${value}" />`;
            }
            
            form += `</div>`;
        }
    });
    
    form += '</form>';
    modalBody.innerHTML = form;
}

async function saveEntity() {
    const form = document.getElementById('entityForm');
    const formData = new FormData(form);
    const data = {};
    
    // Convert form data to proper types based on metadata
    entityMetadata.properties.forEach(prop => {
        if (prop.isKey && !isEditMode) {
            // Skip key property for create
            return;
        }
        
        const value = formData.get(prop.name);
        if (value === null || value === undefined) {
            // Handle checkbox - if not checked, it won't be in formData
            if (prop.inputType === 'checkbox') {
                data[prop.name] = false;
            }
            return;
        }
        
        // Convert value based on type
        if (prop.inputType === 'checkbox') {
            data[prop.name] = value === 'on' || value === true;
        } else if (prop.inputType === 'number') {
            const numValue = prop.type.includes('decimal') || prop.type.includes('float') || prop.type.includes('double')
                ? parseFloat(value)
                : parseInt(value);
            data[prop.name] = isNaN(numValue) ? null : numValue;
        } else if (prop.inputType === 'datetime-local' || prop.inputType === 'date' || prop.inputType === 'time') {
            data[prop.name] = value || null;
        } else {
            data[prop.name] = value || null;
        }
    });
    
    try {
        const url = isEditMode 
            ? `/DBAdminPanel/Entity/api/${entityName}/${currentEntity[entityMetadata.keyProperty]}`
            : `/DBAdminPanel/Entity/api/${entityName}`;
        const method = isEditMode ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error('Failed to save entity: ' + errorText);
        }
        
        bootstrap.Modal.getInstance(document.getElementById('entityModal')).hide();
        loadEntities();
    } catch (error) {
        showError('Failed to save entity: ' + error.message);
    }
}

async function deleteEntity(id) {
    if (!confirm('Are you sure you want to delete this entity?')) return;
    
    try {
        const response = await fetch(`/DBAdminPanel/Entity/api/${entityName}/${id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('Failed to delete entity');
        loadEntities();
    } catch (error) {
        showError('Failed to delete entity: ' + error.message);
    }
}

function viewDetails(id) {
    loadEntity(id);
    // Could show read-only view or navigate to details page
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorMessage').style.display = 'block';
    document.getElementById('loadingMessage').style.display = 'none';
}

// Initialize on page load
if (entityName) {
    loadMetadata();
} else {
    showError('Entity name not specified');
}
</script>

